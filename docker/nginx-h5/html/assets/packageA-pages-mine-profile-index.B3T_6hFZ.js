import{d as e,h as a,P as l,j as t,k as u,l as s,a as o,b as i,o as n,w as r,e as c,i as d,f as v,n as m,q as p,J as h,g as f,t as g,u as w,K as _,ak as b,M as x,ah as y,au as k,$ as j,av as S,y as T,al as M,z as V,ar as $,ap as C,E as P,G as N,R as I,ae as q}from"./index-5U173LQ3.js";import{a as H,d as E,m as R,b as U,c as A,o as W,e as z,_ as F}from"./wd-icon.CDbxLjoy.js";import{_ as L}from"./wd-img.B2iROZ-I.js";import{_ as X}from"./wd-cell.yQBIY-AL.js";import{_ as Y}from"./wd-cell-group.CJNVuq-S.js";import{_ as B}from"./wd-button.BzRx3gca.js";import{u as D}from"./useTranslate.Kg86_MV8.js";import{_ as O}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{_ as G}from"./wd-input.C2gvQ-R0.js";import{w as J,a as K}from"./wd-radio-group.DF6hNek8.js";import{_ as Q}from"./wd-form.BbkYwo7Z.js";import{w as Z}from"./wd-popup.BsbILK4T.js";import{c as ee}from"./auth.BcWY81ex.js";import"./useCell.qN6vSEvF.js";import"./useParent.Bak0uCS8.js";import"./types.DZx-jF8C.js";import"./types.Prh_CF5p.js";import"./useChildren.Crbe03ZE.js";import"./base64.3RFQOR3W.js";import"./index.BkHvPazf.js";import"./wd-toast.BszgenSq.js";import"./wd-overlay.iGBdgU4M.js";import"./wd-transition.7-0aPBrJ.js";const ae=e({name:"wd-img-cropper",options:{virtualHost:!0,addGlobalClass:!0,styleIsolation:"shared"},props:{...A,modelValue:U(!1),cancelButtonText:String,confirmButtonText:String,disabledRotate:U(!1),fileType:R("png"),quality:H(1),exportScale:H(2),imgSrc:R(""),imgWidth:E(""),imgHeight:E(""),maxScale:H(3)},emits:["imgloaded","imgloaderror","cancel","confirm","update:modelValue"],setup(e,{expose:y,emit:k}){let j=null,S=null,T=!0,M=null,V=null;const $=.85,C=e,P=k,{translate:N}=D("img-cropper"),I=a(0),q=a(!1),H=a(0),E=a(0),R=a(0),U=a(0),A=a(20),L=a(0),X=a(0),Y=a(""),O=a(""),G=a(2),J=a(1),K=a(l().windowWidth/2),Q=a(l().windowHeight/2*$),Z=a(null),ee=a(l()),ae=a(!0),le=a([{x:"",y:""},{x:"",y:""}]),te=a(""),ue=a(null),{proxy:se}=t();u((()=>C.modelValue),(e=>{if(e){M=C.imgWidth,V=C.imgHeight,ee.value=l();const e=ee.value.windowWidth-2*A.value;R.value=e,U.value=e,X.value=(ee.value.windowHeight*$-e)/2,L.value=A.value,G.value=C.exportScale,O.value=e,Y.value=e,function(){if(M&&"string"==typeof M&&-1!==M.indexOf("%")){const e=M.replace("%","");M=ee.value.windowWidth/100*Number(e),H.value=M}else M&&"number"==typeof M&&(H.value=M);if(V&&"string"==typeof V&&-1!==V.indexOf("%")){const e=C.imgHeight.replace("%","");V=ee.value.windowHeight/100*Number(e),H.value=V}else V&&"number"==typeof V&&(H.value=Number(M))}(),ue.value||(ue.value=x("wd-img-cropper-canvas",se)),C.imgSrc&&de()}else ce()}),{deep:!0,immediate:!0}),u((()=>C.imgSrc),(e=>{e&&de()}),{deep:!0,immediate:!0}),u((()=>I.value),(e=>{e%90&&(I.value=90*Math.round(e/90))}),{deep:!0,immediate:!0}),u((()=>q.value),(e=>{j&&clearTimeout(j),e&&(j=setTimeout((()=>{ne(!1),clearTimeout(j)}),300))}),{deep:!0,immediate:!0});const oe=s((()=>W({position:"absolute",right:0,width:"56px","border-radius":"16px","font-size":"16px"}))),ie=s((()=>{const e={width:H.value?z(H.value):"auto",height:E.value?z(E.value):"auto",transform:`translate(${z(K.value-H.value/2)}, ${z(Q.value-E.value/2)}) scale(${J.value}) rotate(${I.value}deg)`,"transition-duration":(q.value?.4:0)+"s"};return W(e)}));function ne(e){q.value=e}function re(e){e&&!C.disabledRotate&&(ne(!0),I.value=e,ve())}function ce(){const{windowHeight:e,windowWidth:a}=l();J.value=1,I.value=0,K.value=a/2,Q.value=e/2*$}function de(){C.imgSrc&&b({src:C.imgSrc,success:e=>{Z.value=e,function(){let e=H.value,a=E.value;V||M?V&&!M?e=Z.value.width/Z.value.height*Number(V):(!V&&M||V&&M)&&(a=Z.value.height/Z.value.width*Number(M)):(e=Z.value.width,a=Z.value.height,H.value/E.value>R.value/U.value?(a=U.value,e=Z.value.width/Z.value.height*U.value):(e=R.value,a=Z.value.height/Z.value.width*R.value));H.value=e,E.value=a}(),ce()},fail:()=>{}})}function ve(e){const a=e||J.value;let l=K.value,t=Q.value,u=H.value,s=E.value;I.value/90%2&&(u=E.value,s=H.value),l=u*a/2+L.value>=l?l:u*J.value/2+L.value,l=L.value+R.value-u*a/2<=l?l:L.value+R.value-u*a/2,t=s*a/2+X.value>=t?t:s*a/2+X.value,t=X.value+U.value-s*a/2<=t?t:X.value+U.value-s*a/2,J.value=a,Q.value=t,K.value=l}function me(e){if(ae.value=!1,1===e.touches.length)le.value[0]={x:e.touches[0].clientX-K.value,y:e.touches[0].clientY-Q.value};else{const a=Math.abs(e.touches[1].clientX-e.touches[0].clientX),l=Math.abs(e.touches[1].clientY-e.touches[0].clientY);te.value=Math.sqrt(Math.pow(a,2)+Math.pow(l,2))}}function pe(e){if(!ae.value&&T)if("android"===ee.value.platform?(S&&clearTimeout(S),S=setTimeout((()=>{T=!0}),25)):!T&&(T=!0),1===e.touches.length){const{x:a,y:l}=le.value[0],t=e.touches[0].clientX-Number(a),u=e.touches[0].clientY-Number(l);K.value=t,Q.value=u,ve()}else{const a=Math.abs(e.touches[1].clientX-e.touches[0].clientX),l=Math.abs(e.touches[1].clientY-e.touches[0].clientY),t=Math.sqrt(Math.pow(a,2)+Math.pow(l,2)),u=J.value*(t/Number(te.value));J.value=Math.min(u,C.maxScale),function(){let e=H.value,a=E.value,l=J.value;I.value/90%2&&(e=E.value,a=H.value),e*l<R.value&&(l=R.value/e),a*l<U.value&&(l=U.value/a),ve(l)}(),te.value=Math.sqrt(Math.pow(a,2)+Math.pow(l,2))}}function he(){ae.value=!0}function fe(e){P("imgloaded",e)}function ge(e){P("imgloaderror",e)}function we(){re(I.value-90)}function _e(){P("cancel"),P("update:modelValue",!1)}function be(){!function(){if(!C.imgSrc)return;const e=()=>{const e=H.value*J.value*C.exportScale,a=E.value*J.value*C.exportScale,l=K.value-L.value,t=Q.value-X.value;ue.value.translate(l*C.exportScale,t*C.exportScale),C.disabledRotate||ue.value.rotate(I.value*Math.PI/180),ue.value.drawImage(C.imgSrc,-e/2,-a/2,e,a),ue.value.restore(),ue.value.draw(!1,(()=>{!function(){const{fileType:e,quality:a,exportScale:l}=C;_({width:R.value*l,height:Math.round(U.value*l),destWidth:R.value*l,destHeight:Math.round(U.value*l),fileType:e,quality:a,canvasId:"wd-img-cropper-canvas",success:e=>{const a={tempFilePath:e.tempFilePath,width:R.value*l,height:U.value*l};P("confirm",a)},complete:()=>{P("update:modelValue",!1)}},se)}()}))};O.value=U.value,Y.value=R.value,e()}()}function xe(){}return y({revertIsAnimation:ne,setRoate:re,resetImg:ce}),(e,a)=>{const l=d,t=p,u=h;return e.modelValue?(n(),o(l,{key:0,class:m(`wd-img-cropper ${e.customClass}`),style:v(e.customStyle),onTouchmove:xe},{default:r((()=>[c(l,{class:"wd-img-cropper__wrapper"},{default:r((()=>[c(l,{class:"wd-img-cropper__cut"},{default:r((()=>[c(l,{class:m("wd-img-cropper__cut--top "+(ae.value?"":"is-hightlight")),style:v(`height: ${X.value}px;`)},null,8,["class","style"]),c(l,{class:"wd-img-cropper__cut--middle"},{default:r((()=>[c(l,{class:m("wd-img-cropper__cut--left "+(ae.value?"":"is-hightlight")),style:v(`width: ${L.value}px; height: ${R.value}px;`)},null,8,["class","style"]),c(l,{class:"wd-img-cropper__cut--body",style:v(`width: ${R.value}px; height: ${U.value}px;`)},{default:r((()=>[c(l,{class:"is-gridlines-x"}),c(l,{class:"is-gridlines-y"}),c(l,{class:"is-left-top"}),c(l,{class:"is-left-bottom"}),c(l,{class:"is-right-top"}),c(l,{class:"is-right-bottom"})])),_:1},8,["style"]),c(l,{class:m("wd-img-cropper__cut--right "+(ae.value?"":"is-hightlight"))},null,8,["class"])])),_:1}),c(l,{class:m("wd-img-cropper__cut--bottom "+(ae.value?"":"is-hightlight"))},null,8,["class"])])),_:1}),c(t,{prop:q.value,"change:prop":e.animation?e.animation.setAnimation:"",class:"wd-img-cropper__img",src:e.imgSrc,style:v(ie.value),"lazy-load":!1,onTouchstart:me,onTouchmove:pe,onTouchend:he,onError:ge,onLoad:fe},null,8,["prop","change:prop","src","style"])])),_:1}),c(u,{"canvas-id":"wd-img-cropper-canvas",id:"wd-img-cropper-canvas",class:"wd-img-cropper__canvas","disable-scroll":!0,style:v(`width: ${Number(Y.value)*G.value}px; height: ${Number(O.value)*G.value}px;`)},null,8,["style"]),c(l,{class:"wd-img-cropper__footer"},{default:r((()=>[e.disabledRotate?i("",!0):(n(),o(F,{key:0,"custom-class":"wd-img-cropper__rotate",name:"rotate",onClick:we})),c(l,{class:"wd-img-cropper__footer--button"},{default:r((()=>[c(l,{class:"is-cancel",onClick:_e},{default:r((()=>[f(g(e.cancelButtonText||w(N)("cancel")),1)])),_:1}),c(B,{size:"small","custom-style":oe.value,onClick:be},{default:r((()=>[f(g(e.confirmButtonText||w(N)("confirm")),1)])),_:1},8,["custom-style"])])),_:1})])),_:1})])),_:1},8,["class","style"])):i("",!0)}}});const le={setAnimation:function(e,a,l){if(e)var t=l.setTimeout((function(){l.callMethod("revertIsAnimation",!1),l.clearTimeout(t)}),300)}},te=e=>{e.$wxs||(e.$wxs=[]),e.$wxs.push("animation"),e.mixins||(e.mixins=[]),e.mixins.push({beforeCreate(){this.animation=le}})};te(ae);const ue=O(ae,[["__scopeId","data-v-63558908"]]);let se={}.VITE_APP_API_URL;se="/prod-api";const oe={uploadUrl:"/prod-api/api/v1/files",upload(e){return new Promise(((a,l)=>{y({url:this.uploadUrl,filePath:e,name:"file",header:{Authorization:k()?`Bearer ${k()}`:""},formData:{},success:e=>{const t=JSON.parse(e.data);t.code===S.SUCCESS?a(t.data):(j({title:t.msg||"文件上传失败",icon:"none"}),l({message:t.msg||"业务处理失败",code:t.code}))},fail:e=>{console.log("fail error",e),j({title:"文件上传请求失败",icon:"none",duration:2e3}),l({message:"文件上传请求失败",error:e})}})}))}},ie=O(e({__name:"index",setup(e){const l=a(""),t=a(!1),u=a(),s=async()=>{u.value=await C.getProfile()};function v(){q({count:1,success:e=>{l.value=e.tempFilePaths[0],t.value=!0}})}function m(e){const{tempFilePath:a}=e;oe.upload(a).then((e=>{const a={avatar:e.url};C.updateProfile(a).then((()=>{j({title:"头像上传成功",icon:"none"}),s()}))}))}const p=T({nickname:[{required:!0,message:"请填写昵称"}],gender:[{required:!0,message:"请选择性别"}]}),h=T({visible:!1}),g=T({}),_=a(),b=()=>{var e,a;h.visible=!0,g.nickname=null==(e=u.value)?void 0:e.nickname,g.gender=null==(a=u.value)?void 0:a.gender};function x(){_.value.validate().then((({valid:e})=>{e&&C.updateProfile(g).then((()=>{j({title:"账号资料修改成功",icon:"none"}),h.visible=!1,s()}))}))}function y(e){e.touches.length>1&&e.preventDefault()}function k(e){e.preventDefault()}return M((()=>{ee()&&(document.addEventListener("touchstart",y,{passive:!1}),document.addEventListener("touchmove",k,{passive:!1}),s())})),V((()=>{})),$((()=>{document.removeEventListener("touchstart",y),document.removeEventListener("touchmove",k)})),(e,a)=>{const s=P(N("wd-icon"),F),y=d,k=P(N("wd-img"),L),j=P(N("wd-cell"),X),S=P(N("wd-cell-group"),Y),T=P(N("wd-img-cropper"),ue),M=P(N("wd-input"),G),V=P(N("wd-radio"),J),$=P(N("wd-radio-group"),K),C=P(N("wd-button"),B),q=P(N("wd-form"),Q),H=P(N("wd-popup"),Z);return n(),o(y,{class:"profile"},{default:r((()=>[w(u)?(n(),o(y,{key:0,class:"profile-card"},{default:r((()=>[c(S,{border:"",class:"border"},{default:r((()=>[c(j,{class:"avatar-cell center is-link",title:"头像",center:"","is-link":""},{default:r((()=>[c(y,{class:"avatar"},{default:r((()=>[w(u).avatar?i("",!0):(n(),o(y,{key:0,class:"img",onClick:v},{default:r((()=>[c(s,{name:"fill-camera","custom-class":"img-icon"})])),_:1})),w(u).avatar?(n(),o(k,{key:1,round:"",width:"80px",height:"80px",src:w(u).avatar,mode:"aspectFit","custom-class":"profile-img",onClick:v,class:"round"},null,8,["src"])):i("",!0)])),_:1})])),_:1}),c(j,{title:"昵称",value:w(u).nickname,"is-link":"",onClick:a[0]||(a[0]=e=>b()),class:"is-link"},null,8,["value"]),c(j,{title:"性别",value:1===w(u).gender?"男":2===w(u).gender?"女":"未知","is-link":"",onClick:a[1]||(a[1]=e=>b()),class:"is-link"},null,8,["value"]),c(j,{title:"用户名",value:w(u).username},null,8,["value"]),c(j,{title:"部门",value:w(u).deptName},null,8,["value"]),c(j,{title:"角色",value:w(u).roleNames},null,8,["value"]),c(j,{title:"创建日期",value:w(u).createTime},null,8,["value"])])),_:1})])),_:1})):i("",!0),c(T,{modelValue:w(t),"onUpdate:modelValue":a[2]||(a[2]=e=>I(t)?t.value=e:null),"img-src":w(l),onConfirm:m},null,8,["modelValue","img-src"]),c(H,{modelValue:w(h).visible,"onUpdate:modelValue":a[5]||(a[5]=e=>w(h).visible=e),position:"bottom"},{default:r((()=>[c(q,{ref_key:"userProfileFormRef",ref:_,model:w(g),"custom-class":"edit-form"},{default:r((()=>[c(S,{border:"",class:"border"},{default:r((()=>[c(M,{modelValue:w(g).nickname,"onUpdate:modelValue":a[3]||(a[3]=e=>w(g).nickname=e),label:"昵称","label-width":"160rpx",placeholder:"请输入昵称",prop:"nickname",rules:w(p).nickname},null,8,["modelValue","rules"]),c(j,{title:"性别","title-width":"160rpx",center:"",prop:"gender",rules:w(p).gender,class:"center"},{default:r((()=>[c($,{modelValue:w(g).gender,"onUpdate:modelValue":a[4]||(a[4]=e=>w(g).gender=e),shape:"button",class:"ef-radio-group"},{default:r((()=>[c(V,{value:1},{default:r((()=>[f("男")])),_:1}),c(V,{value:2},{default:r((()=>[f("女")])),_:1})])),_:1},8,["modelValue"])])),_:1},8,["rules"])])),_:1}),c(y,{class:"footer"},{default:r((()=>[c(C,{type:"primary",size:"large",block:"",onClick:x,class:"block"},{default:r((()=>[f("提交")])),_:1})])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])),_:1})}}}),[["__scopeId","data-v-2af7ebac"]]);export{ie as default};
